#!/bin/bash

set -o nounset
set -o noclobber

if [ ! -x revdep/testDrive ]; then
  echo "$0 must be run from the top of the package directory"
  exit 1
fi

# add --depth=50 later TODO
git submodule update --init --recursive || exit 1

pkgs="ctsem lvnet metasem semtree umx"

R --no-save -f util/update-dependencies.R --args \
  $(perl -e 'print(join " ", map { "revdep/$_/DESCRIPTION" } @ARGV )' $pkgs)

pushd revdep

# investigate devtools,
# https://www.rdocumentation.org/packages/devtools/versions/1.12.0/topics/revdep_check_save_summary?

declare -i RESULT=0

for pk in $pkgs; do
    R CMD build "$pk" && R CMD check --no-manual --no-build-vignettes ${pk}_*.tar.gz
    RESULT+=$?
done

exit $RESULT
