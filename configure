#!/bin/sh

set -o errexit
set -o nounset

isdef() {
    tmp1=/tmp/openmx.$$.cpp
    tmp2=/tmp/openmx.$$.out
    trap 'rm -f $tmp1 $tmp2' EXIT
    cat >$tmp1 <<EOF
int main()
{
#ifndef $1
crash me
#endif
	; return 0;
}
EOF
    $CXX -c $tmp1 -o $tmp2 > /dev/null 2>&1
}

: ${R_HOME:=`R RHOME`}
if test -z "${R_HOME}"; then 
   echo "could not determine R_HOME" 
   exit 1 
fi 

REXEC=${R_HOME}/bin/R

CXX=$($REXEC CMD config CXX)

COMPILER_CXXFLAGS=
COMPILER_LDFLAGS=
arch_CXXFLAGS=
arch_LDFLAGS=
OPENMP_CXXFLAGS=
OPENMP_LDFLAGS=

if isdef __clang__; then
    cxx_type=clang
elif isdef __llvm__; then
    cxx_type=llvm
elif isdef __GNUC__; then
    cxx_type=gcc
else
    echo "Compiler unrecognized:"
    $CXX --version
    exit 1
fi

if [ "$cxx_type" = gcc ]; then
    COMPILER_CXXFLAGS="-Wall -Wno-unknown-pragmas"
    OPENMP_CXXFLAGS="-fopenmp"
    OPENMP_LDFLAGS="-fopenmp"
fi

cxx_version=$($CXX -dumpversion | awk -F '.' '{print $1 "." $2}')

host_cpu=$(uname -p)
case "$host_cpu" in
    *86_64) omx_arch=x86_64 ;;
    *86) omx_arch=x86 ;;
    *)
	echo "Host arch is not recognized: ${host_cpu}"
	exit 1
	;;
esac

npsol_dir='inst/npsol'

os=$(uname -s)
case "$os" in
    *Linux)
	omx_os=linux
	npsol_library="${npsol_dir}/linux/${omx_arch}/gcc${cxx_version}"
	;;
    *Darwin)
	omx_os=osx
	arch_LDFLAGS="-mmacosx-version-min=10.4"
	arch_CXXFLAGS="-mmacosx-version-min=10.4"
	npsol_library="${npsol_dir}/osx"
	;;
    *)
	echo "Host os is not recognized: $os"
	exit 1
	;;
esac

echo "### Generated $(date)" > src/Makevars
echo >> src/Makevars

if [ ! -e inst/no-npsol ]; then
    npsol_file="${npsol_library}/libnpsol.a"
    if [ ! -f "$npsol_file" ]; then
	echo "$npsol_file not found"
	exit 1
    else
	echo "NPSOL_LDFLAGS=-L../${npsol_library} -lnpsol" >> src/Makevars
    fi
fi

echo "ARCH_SPECIFIC_LINKER_FLAGS=$arch_LDFLAGS" >> src/Makevars
echo "ARCH_SPECIFIC_COMPILER_FLAGS=$arch_CXXFLAGS" >> src/Makevars
echo "COMPILER_CXXFLAGS=$COMPILER_CXXFLAGS" >> src/Makevars
echo "COMPILER_LDFLAGS=$COMPILER_LDFLAGS" >> src/Makevars
echo "OPENMP_CXXFLAGS=$OPENMP_CXXFLAGS" >> src/Makevars
echo "OPENMP_LDFLAGS=$OPENMP_LDFLAGS" >> src/Makevars
echo >> src/Makevars
echo "# ---- appending Makevars.in ----" >> src/Makevars
echo >> src/Makevars
cat src/Makevars.in >> src/Makevars
