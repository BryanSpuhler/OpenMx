#!/bin/sh

set -o errexit
set -o nounset

: ${R_HOME:=`R RHOME`}
if test -z "${R_HOME}"; then 
   echo "could not determine R_HOME" 
   exit 1 
fi 

REXEC=${R_HOME}/bin/R

CXX=$($REXEC CMD config CXX)
cxx_info=$($CXX --version | head -1)

COMPILER_CXXFLAGS=
arch_LDFLAGS=
arch_CXXFLAGS=

if echo "$cxx_info" | grep -q '^g++'; then
    cxx_type=gcc
    COMPILER_CXXFLAGS="-Wall -fopenmp"
    COMPILER_LDFLAGS="-fopenmp"
elif echo "$cxx_info" | grep -q LLVM; then
    cxx_type=llvm
else
    echo "Compiler unrecognized:"
    echo "$cxx_info"
    exit 1
fi

cxx_version=$($CXX -dumpversion | awk -F '.' '{print $1 "." $2}')

host_cpu=$(uname -p)
case "$host_cpu" in
    *86_64) omx_arch=x86_64 ;;
    *86) omx_arch=x86 ;;
    *)
	echo "Host arch is not recognized: ${host_cpu}"
	exit 1
	;;
esac

npsol_dir='inst/npsol'

os=$(uname -s)
case "$os" in
    *Linux)
	omx_os=linux
	npsol_library="${npsol_dir}/linux/${omx_arch}/gcc${cxx_version}"
	;;
    *Darwin)
	omx_os=osx
	arch_LDFLAGS="-mmacosx-version-min=10.4"
	arch_CXXFLAGS="-mmacosx-version-min=10.4"
	npsol_library="${npsol_dir}/osx"
	;;
    *)
	echo "Host os is not recognized: $os"
	exit 1
	;;
esac

npsol_file="${npsol_library}/libnpsol.a"
if [ ! -f "$npsol_file" ]; then
  echo "$npsol_file not found"
  exit 1
fi

echo "### Generated $(date)" > src/Makevars
echo >> src/Makevars
echo "NPSOL_DIR=../${npsol_library}" >> src/Makevars
echo "ARCH_SPECIFIC_LINKER_FLAGS=$arch_LDFLAGS" >> src/Makevars
echo "ARCH_SPECIFIC_COMPILER_FLAGS=$arch_CXXFLAGS" >> src/Makevars
echo "COMPILER_CXXFLAGS=$COMPILER_CXXFLAGS" >> src/Makevars
echo "COMPILER_LDFLAGS=$COMPILER_LDFLAGS" >> src/Makevars
echo >> src/Makevars
echo "# ---- appending Makevars.in ----" >> src/Makevars
echo >> src/Makevars
cat src/Makevars.in >> src/Makevars
