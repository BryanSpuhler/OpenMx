# echo 0 > /proc/self/coredump_filter  # normally 023
# R --vanilla --no-save -f models/failing/bock-aitkin-1981.R
# R -d gdb --vanilla --no-save -f models/failing/bock-aitkin-1981.R

#options(error = browser)
require(mirt)
require(OpenMx)
require(rpf)
library(stringr)

data(SAT12)
data <- key2binary(SAT12,
                   key = c(1,4,5,2,3,1,2,1,3,1,2,4,2,1,5,3,4,4,1,4,3,3,4,1,3,5,1,3,1,5,4,5))
df <- list()
for (cx in 1:dim(data)[2]) {
	df[[cx]] <- factor(data[,cx], levels=c(0,1))
}
df <- as.data.frame(df)
colnames(df) <- str_replace_all(colnames(data), "\\.", "")

numItems <- 32
numPersons <- dim(data)[1]
maxDim <- 2

items <- vector("list", numItems)
for (ix in 1:numItems) {
	items[[ix]] <- rpf.drm(dimensions=maxDim)
}

maxParam <- max(vapply(items, function(i) i@numParam, 0))
maxOutcomes <- max(vapply(items, function(i) i@numOutcomes, 0))

design <- matrix(c(rep(1,numItems),
		   1+c(2,3,2,3,3,2,1,2,1,1,1,3,1,3,1,2,1,1,3,3,1,1,3,1,3,3,1,3,2,3,1,2)), byrow=TRUE, nrow=2)

spec <- mxMatrix(name="ItemSpec", nrow=3, ncol=numItems,
         values=c(rep(mxLookupIRTItemModelID("drm"), numItems),
		 rep(2, numItems),
		 rep(2, numItems)),
         free=FALSE, byrow=TRUE)

design <- mxMatrix(name="Design", nrow=maxDim, ncol=numItems,
		   values=design)

ip.mat <- mxMatrix(name="ItemParam", nrow=maxParam, ncol=numItems,
                   values=c(
		     rep(1.414,numItems),
		     rep(1,numItems),
		     rep(0,numItems),
		     rep(0,numItems)),
         free=c(rep(TRUE, numItems*3),
                rep(FALSE, numItems*1)),
         byrow=TRUE)

#ip.mat@values[2,1] <- correct.mat[2,1]
#ip.mat@free[2,1] <- FALSE

m1 <- mxModel(model="sat12",
          spec, design,
          ip.mat,
          mxMatrix(name="A", values=c(1,1,0,0), nrow=1, ncol=maxParam, free=FALSE),
          mxAlgebra(name="prior",
                    sum(dlnorm(omxSelectRows(ItemParam, A), 0, .5, 1))),
          mxData(observed=df, type="raw"),
          mxExpectationBA81(
	     ItemSpec="ItemSpec",
	     Design="Design",
	     ItemParam="ItemParam",
	     ItemPrior="prior",
	     GHpoints=5),
          mxFitFunctionBA81()
)

m1 <- mxOption(m1, "Calculate Hessian", "No")
m1 <- mxOption(m1, "Standard Errors", "No")

m1 <- mxRun(m1, silent=TRUE)
print(m1@matrices$ItemParam@values)
q()

           [,1]      [,2]       [,3]       [,4]      [,5]       [,6]      [,7]
[1,]  0.8376999 1.4723685  1.1031764  0.5744329 0.9719702  1.1585834 0.9218775
[2,]  0.7487970 0.6815570  0.3742071  0.5515402 0.5317541  0.6486719 0.9102969
[3,] -1.2279915 0.2840084 -1.2809699 -0.6251109 0.5146909 -2.2669150 1.3849675
[4,]  0.0000000 0.0000000  0.0000000  0.0000000 0.0000000  0.0000000 0.0000000
           [,8]      [,9]      [,10]     [,11]      [,12]     [,13]     [,14]
[1,]  0.7017704 0.5143704  0.9777125 1.1610600  0.2643377 1.0287150 1.0652408
[2,]  0.5622452 0.7042576  0.5760297 0.8716291  0.4584727 0.7121345 0.8117676
[3,] -1.6590729 2.2344313 -0.4948756 4.8329205 -0.3992027 0.7572313 1.1547767
[4,]  0.0000000 0.0000000  0.0000000 0.0000000  0.0000000 0.0000000 0.0000000
         [,15]      [,16]     [,17]      [,18]     [,19]     [,20]     [,21]
[1,] 1.1645968  0.7791490 1.2005737  1.7309522 0.8504954 1.5138810 0.5582002
[2,] 0.9822995  0.5879044 0.8116025  0.4625639 0.3196094 0.5329757 0.7311481
[3,] 1.9151916 -0.4881185 3.9507981 -1.0745089 0.1484389 2.4851178 2.6186127
[4,] 0.0000000  0.0000000 0.0000000  0.0000000 0.0000000 0.0000000 0.0000000
        [,22]      [,23]     [,24]      [,25]      [,26]     [,27]      [,28]
[1,] 1.346159  0.6381264 1.1245171  0.7690966  1.5127376 1.7705382 1.06302051
[2,] 0.650306  0.6042764 0.6805393  0.6636540  0.5617481 0.6164787 0.35054250
[3,] 3.298154 -0.9759576 1.1710634 -0.6938939 -0.3447076 2.5411875 0.05844035
[4,] 0.000000  0.0000000 0.0000000  0.0000000  0.0000000 0.0000000 0.00000000
          [,29]      [,30]     [,31]      [,32]
[1,]  0.9073331  0.4331988 2.1788873  0.2968511
[2,]  0.7951424  0.2756253 0.4756182  0.4238714
[3,] -0.9259258 -0.3018908 2.4618333 -1.7648565
[4,]  0.0000000  0.0000000 0.0000000  0.0000000

           [,1]      [,2]       [,3]       [,4]      [,5]       [,6]     [,7]
[1,]  1.0870131 1.8311911  1.4649957  0.7043999 1.2233223  1.5282974 1.130744
[2,]  0.9529706 1.0048999  0.4548227  0.7295729 0.7203948  0.7992314 1.237652
[3,] -1.1338079 0.4082707 -1.1825607 -0.5605575 0.5988205 -2.1394901 1.463133
[4,]  0.0000000 0.0000000  0.0000000  0.0000000 0.0000000  0.0000000 0.000000
           [,8]      [,9]      [,10]     [,11]      [,12]     [,13]    [,14]
[1,]  0.9197668 0.6169525  1.2241897 1.4775190  0.3325507 1.2940938 1.252004
[2,]  0.7061701 0.8905425  0.7679923 0.8749206  0.5250451 0.9487344 1.286791
[3,] -1.5787532 2.2566377 -0.3956155 4.7883818 -0.3633637 0.8475354 1.258289
[4,]  0.0000000 0.0000000  0.0000000 0.0000000  0.0000000 0.0000000 0.000000
        [,15]      [,16]     [,17]      [,18]     [,19]     [,20]     [,21]
[1,] 1.505273  0.9803639 1.4191277  2.3402452 1.0429807 1.8679377 0.6419022
[2,] 1.213335  0.7552712 0.9630831  0.5596747 0.4348018 0.6559302 0.9478943
[3,] 1.994795 -0.4116009 3.9293130 -0.9265793 0.2218874 2.5600682 2.6388024
[4,] 0.000000  0.0000000 0.0000000  0.0000000 0.0000000 0.0000000 0.0000000
         [,22]      [,23]     [,24]      [,25]      [,26]     [,27]     [,28]
[1,] 1.6642266  0.7743136 1.3667584  1.0040851  1.9677807 2.2310480 1.3355577
[2,] 0.7690493  0.8037316 0.9434432  0.7992659  0.7306509 0.7612358 0.4624208
[3,] 3.3456913 -0.8993785 1.2570681 -0.6076909 -0.2114263 2.6600838 0.1498181
[4,] 0.0000000  0.0000000 0.0000000  0.0000000  0.0000000 0.0000000 0.0000000
          [,29]      [,30]     [,31]      [,32]
[1,]  1.1537188  0.5559102 2.4189941  0.3584264
[2,]  1.0485261  0.3332731 0.6504718  0.5216994
[3,] -0.8307081 -0.2583710 2.4481233 -1.7186821
[4,]  0.0000000  0.0000000 0.0000000  0.0000000

LL 8704.34251
